name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
      - '[0-9]+.*'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-tag:
    name: Validate Tag
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Validate tag format
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ ! "$TAG_NAME" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Tag format is invalid. Expected format: v1.2.3 or 1.2.3"
            exit 1
          fi
          echo "âœ… Tag format is valid: $TAG_NAME"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: validate-tag

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-interaction --no-dev

      - name: Get previous tag
        id: previoustag
        run: |
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${{ github.ref_name }}$" | head -n 1)
          echo "tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREVIOUS_TAG"

      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4.6.2
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}
          head-ref: ${{ github.ref_name }}
          base-ref: ${{ steps.previoustag.outputs.tag }}

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Check if version matches composer.json
        run: |
          COMPOSER_VERSION=$(php -r "echo json_decode(file_get_contents('composer.json'))->version ?? 'not-set';")
          TAG_VERSION="${{ steps.version.outputs.version }}"

          if [ "$COMPOSER_VERSION" != "not-set" ] && [ "$COMPOSER_VERSION" != "$TAG_VERSION" ]; then
            echo "::warning::Version in composer.json ($COMPOSER_VERSION) doesn't match tag ($TAG_VERSION)"
          fi

      - name: Determine if pre-release
        id: prerelease
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" =~ (alpha|beta|rc) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a pre-release"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "This is a stable release"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.changelog }}

            ## Installation

            ```bash
            composer require palpalani/baylinks-laravel:^${{ steps.version.outputs.version }}
            ```

            ## Full Changelog

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.previoustag.outputs.tag }}...${{ github.ref_name }}
          draft: false
          prerelease: ${{ steps.prerelease.outputs.prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on related PRs
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ github.ref_name }}';
            const releaseUrl = `https://github.com/${{ github.repository }}/releases/tag/${tag}`;

            // Find merged PRs since last tag
            const { data: commits } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: '${{ steps.previoustag.outputs.tag }}',
              head: tag
            });

            const prNumbers = new Set();
            for (const commit of commits.commits) {
              const prMatch = commit.commit.message.match(/#(\d+)/);
              if (prMatch) {
                prNumbers.add(prMatch[1]);
              }
            }

            for (const prNumber of prNumbers) {
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `ðŸŽ‰ This PR has been included in [${tag}](${releaseUrl})!`
                });
              } catch (error) {
                console.log(`Could not comment on PR #${prNumber}: ${error.message}`);
              }
            }

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: create-release
    if: success()

    steps:
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Package will be available on Packagist shortly" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation has been updated automatically" >> $GITHUB_STEP_SUMMARY
          echo "- Changelog has been generated" >> $GITHUB_STEP_SUMMARY
